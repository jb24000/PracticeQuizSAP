<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS SAP-C02 Strategic Exam Trainer</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#FF9900">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SAP-C02 Trainer">
    <meta name="description" content="Master AWS SAP-C02 exam with 100+ strategic scenarios">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <style>
        :root {
            /* Original SAP color scheme */
            --aws-orange: #FF9900;
            --aws-blue: #232F3E;
            --aws-light-blue: #4B9CD3;
            --success: #4CAF50;
            --error: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
            --dark-bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-light: #e0e0e0;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, system-ui, sans-serif;
            background: linear-gradient(135deg, var(--aws-blue) 0%, #1a1a1a 100%);
            color: var(--text-light);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
        }

        .header h1 {
            color: var(--aws-orange);
            font-size: 2.5em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .aws-badge {
            background: var(--aws-orange);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.5em;
            font-weight: bold;
        }

        .header p {
            color: #999;
            font-size: 1.1em;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--aws-orange);
        }

        .stat-label {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

        /* Controls */
        .controls {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        select, button {
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: var(--text-light);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, button:hover {
            background: #2a2a2a;
            border-color: var(--aws-orange);
        }

        button.primary {
            background: var(--aws-orange);
            color: white;
            border-color: var(--aws-orange);
            font-weight: bold;
        }

        button.primary:hover {
            background: #e88900;
        }

        /* Mode Selection */
        .mode-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .mode-card {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
            border-color: var(--aws-orange);
        }

        .mode-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--aws-orange);
        }

        .mode-card p {
            font-size: 14px;
            opacity: 0.9;
            line-height: 1.5;
            margin-bottom: 15px;
            color: var(--text-light);
        }

        .mode-features {
            list-style: none;
            font-size: 13px;
            opacity: 0.8;
        }

        .mode-features li {
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
            color: var(--text-light);
        }

        .mode-features li:before {
            content: "✓";
            color: var(--success);
            font-weight: bold;
            position: absolute;
            left: 0;
        }

        /* Timer Section */
        .timer-section {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .timer-box {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .timer-label {
            color: #999;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .timer-value {
            color: var(--aws-orange);
            font-size: 2em;
            font-weight: bold;
        }

        .pace-indicator {
            margin-top: 10px;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            font-size: 0.9em;
            display: inline-block;
        }

        .pace-indicator.ok {
            background: var(--success);
        }

        .pace-indicator.warn {
            background: var(--warning);
        }

        .pace-indicator.bad {
            background: var(--error);
        }

        /* Question Card */
        .question-card {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #444;
            flex-wrap: wrap;
            gap: 10px;
        }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            color: white;
        }

        .domain-badge {
            background: var(--aws-light-blue);
        }

        .difficulty-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .difficulty-badge.easy {
            background: var(--success);
            color: white;
        }

        .difficulty-badge.medium {
            background: var(--warning);
            color: white;
        }

        .difficulty-badge.hard {
            background: var(--error);
            color: white;
        }

        .scenario {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--aws-orange);
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 25px;
            color: var(--aws-orange);
            font-weight: 600;
        }

        /* Options */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }

        .option {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            display: flex;
            gap: 15px;
            align-items: flex-start;
        }

        .option:hover:not(.disabled) {
            background: #2a2a2a;
            border-color: var(--aws-orange);
            transform: translateX(5px);
        }

        .option.selected {
            border-color: var(--aws-light-blue);
            background: #1a3a4a;
        }

        .option.correct {
            border-color: var(--success);
            background: rgba(76, 175, 80, 0.1);
        }

        .option.incorrect {
            border-color: var(--error);
            background: rgba(244, 67, 54, 0.1);
        }

        .option.disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .option-letter {
            display: inline-block;
            width: 30px;
            height: 30px;
            background: var(--aws-orange);
            color: white;
            text-align: center;
            line-height: 30px;
            border-radius: 50%;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Explanation */
        .explanation {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            border: 2px solid var(--aws-orange);
            display: none;
        }

        .explanation h3 {
            color: var(--aws-orange);
            margin-bottom: 15px;
        }

        .explanation-section {
            margin-bottom: 20px;
        }

        .explanation-section h4 {
            color: var(--aws-light-blue);
            margin-bottom: 10px;
        }

        .strategy-box {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--aws-orange);
            margin-top: 15px;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .action-button {
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 10px;
            transition: all 0.3s;
        }

        /* Results */
        .results-container {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            text-align: center;
        }

        .results-container h2 {
            color: var(--aws-orange);
            margin-bottom: 30px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8em;
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
            }
            
            .control-group {
                width: 100%;
                justify-content: space-between;
            }
            
            .question-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                🎯 AWS SAP-C02 Strategic Exam Trainer
                <span class="aws-badge">PROFESSIONAL</span>
            </h1>
            <p>Master the AWS Solutions Architect Professional exam with 100+ strategic scenarios</p>
        </div>

        <!-- Mode Selection -->
        <div class="mode-selection" id="modeSelection">
            <div class="mode-card" onclick="startMode('triage')">
                <h3>⚡ Triage Training</h3>
                <p>Learn to identify quick wins vs time sinks in under 30 seconds.</p>
                <ul class="mode-features">
                    <li>Question difficulty recognition</li>
                    <li>30-second decision drills</li>
                    <li>Strategic skip/answer patterns</li>
                </ul>
            </div>
            <div class="mode-card" onclick="startMode('speed')">
                <h3>🔥 Speed Rounds</h3>
                <p>90-second maximum per question – build exam pace muscle memory.</p>
                <ul class="mode-features">
                    <li>Hard 90-second time limits</li>
                    <li>Automatic progression</li>
                    <li>Pace analytics</li>
                </ul>
            </div>
            <div class="mode-card" onclick="startMode('exam')">
                <h3>🎯 Full Exam Simulation</h3>
                <p>Real 180-minute, 75-question exam with strategic coaching.</p>
                <ul class="mode-features">
                    <li>Authentic time pressure</li>
                    <li>Real exam difficulty</li>
                    <li>Strategic alerts & guidance</li>
                </ul>
            </div>
            <div class="mode-card" onclick="startMode('strategic')">
                <h3>🧠 Strategic Practice</h3>
                <p>Learn mark/skip/return workflow with complex scenarios.</p>
                <ul class="mode-features">
                    <li>Flag & review system</li>
                    <li>Flexible timing</li>
                    <li>Decision tree training</li>
                </ul>
            </div>
        </div>

        <!-- Timer Section -->
        <div class="timer-section" id="timerSection">
            <div class="timer-box">
                <div class="timer-label">Global Timer</div>
                <div class="timer-value" id="globalTimer">00:00</div>
            </div>
            <div class="timer-box">
                <div class="timer-label">Question Time</div>
                <div class="timer-value" id="questionTimer">00:00</div>
            </div>
            <div class="timer-box">
                <div class="timer-label">Pace Status</div>
                <div class="timer-value" id="paceValue">Δ +0m 00s</div>
                <div class="pace-indicator ok" id="paceIndicator">ON TRACK</div>
            </div>
        </div>

        <!-- Question Card -->
        <div class="question-card" id="questionContainer">
            <div class="question-header">
                <div>
                    <span class="badge domain-badge" id="domainBadge">Domain</span>
                    <span class="badge difficulty-badge medium" id="difficultyBadge">Medium</span>
                    <span class="badge" style="background: var(--aws-blue);" id="questionNumber">Q1 of N</span>
                </div>
                <div style="display:flex;gap:10px">
                    <button class="primary" onclick="toggleFlag()">🚩 Flag</button>
                    <button onclick="skipQuestion()">⏭️ Skip</button>
                </div>
            </div>

            <div class="scenario" id="scenario"></div>
            <div class="question-text" id="questionText"></div>
            <div class="options-container" id="options"></div>

            <div class="explanation" id="explanation">
                <h3>📚 Explanation</h3>
                <div class="explanation-section">
                    <h4>✅ Correct Answer:</h4>
                    <p id="correctExplanation"></p>
                </div>
                <div class="strategy-box">
                    <h4>🎯 Exam Strategy:</h4>
                    <p id="strategyTip"></p>
                </div>
            </div>

            <div class="action-buttons">
                <button class="action-button" onclick="previousQuestion()">Previous</button>
                <button class="action-button primary" id="submitBtn" onclick="submitAnswer()">Submit Answer</button>
                <button class="action-button primary" id="nextBtn" style="display:none" onclick="nextQuestion()">Next Question →</button>
            </div>
        </div>

        <!-- Results -->
        <div class="results-container" id="resultsContainer">
            <h2>📊 Performance Analysis</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="scoreText">0%</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="correctCount">0/0</div>
                    <div class="stat-label">Correct</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="timeUsed">00:00</div>
                    <div class="stat-label">Time Used</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="flaggedCount">0</div>
                    <div class="stat-label">Flagged</div>
                </div>
            </div>
            <div class="action-buttons" style="margin-top: 30px;">
                <button class="action-button primary" onclick="reviewAnswers()">Detailed Review</button>
                <button class="action-button" onclick="resetQuiz()">Take Another Exam</button>
            </div>
        </div>
    </div>

    <!-- Load question bank -->
    <script src="sap-questionbank.js"></script>

    <script>
    /* ===== Mode config (SAP-specific with DVA timer logic) ===== */
const MODES = {
    triage: { 
        label: 'Triage', 
        total: 10, 
        timePerQ: 30,  // 30 seconds per question
        perQWarn: 30,  // warn at 30 seconds
        globalMin: null, 
        autoAdvance: true, 
        filter: q => (q.difficulty || '').toLowerCase() !== 'easy' 
    },
    speed: { 
        label: 'Speed', 
        total: 40, 
        timePerQ: 90,  // 90 seconds per question
        perQWarn: 90,  // warn at 90 seconds
        globalMin: null, 
        autoAdvance: true, 
        filter: null 
    },
    exam: { 
        label: 'Full Exam', 
        total: 75,  // SAP exam has 75 questions
        timePerQ: null, 
        perQWarn: 144,  // warn at 144 seconds (180 min / 75 questions)
        globalMin: 180,  // 180 minutes for SAP exam
        autoAdvance: false, 
        filter: null 
    },
    strategic: { 
        label: 'Strategic', 
        total: 30, 
        timePerQ: null, 
        perQWarn: null, 
        globalMin: null, 
        autoAdvance: false, 
        filter: null 
    }
};

/* ===== State & helpers ===== */
const state = {
    mode: null,
    questions: [],
    index: 0,
    answers: [],
    correctCount: 0,
    flagged: new Set(),
    skipped: new Set(),
    startedAt: null,
    qStartedAt: null,
    perQTimes: [],
    timers: { global: null, perQ: null }
};

const $ = id => document.getElementById(id);
const pad2 = n => String(n).padStart(2, '0');
const fmt = s => `${pad2((s / 60) | 0)}:${pad2(s % 60)}`;
const dClock = s => { s = Math.abs(s); return `${(s / 60) | 0}m ${pad2(s % 60)}s` };

function sample(arr, n) {
    if (n >= arr.length) return [...arr].sort(() => Math.random() - 0.5);
    const out = [], u = new Set();
    while (out.length < n) {
        const i = (Math.random() * arr.length) | 0;
        if (!u.has(i)) { u.add(i); out.push(arr[i]) }
    }
    return out;
}

function overallDelta(cfg, perQElapsed) {
    const base = cfg.timePerQ || (cfg.globalMin ? Math.round((cfg.globalMin * 60) / state.questions.length) : (cfg.perQWarn || 90));
    const answered = state.answers.filter(a => a !== null).length;
    const expected = answered * base + Math.min(perQElapsed, base);
    const actual = ((Date.now() - state.startedAt) / 1000) | 0;
    return actual - expected; // + behind, - ahead
}

/* ===== Engine ===== */
function startMode(name) {
    if (!Array.isArray(window.questionBank) || !window.questionBank.length) {
        alert('Questions not loaded.');
        return;
    }
    const cfg = MODES[name];
    state.mode = name;
    const pool = cfg.filter ? window.questionBank.filter(cfg.filter) : window.questionBank;
    state.questions = sample(pool, Math.min(cfg.total, pool.length));
    state.index = 0;
    state.answers = new Array(state.questions.length).fill(null);
    state.correctCount = 0;
    state.flagged.clear();
    state.skipped.clear();
    state.perQTimes = new Array(state.questions.length).fill(0);
    state.startedAt = Date.now();

    $('modeSelection').style.display = 'none';
    $('timerSection').style.display = 'grid';
    $('questionContainer').style.display = 'block';
    $('resultsContainer').style.display = 'none';
    $('explanation').style.display = 'none';

    clearInterval(state.timers.global);
    clearInterval(state.timers.perQ);

    if (cfg.globalMin) {
        const end = state.startedAt + cfg.globalMin * 60 * 1000;
        state.timers.global = setInterval(() => {
            const left = Math.max(0, ((end - Date.now()) / 1000) | 0);
            $('globalTimer').textContent = fmt(left);
            if (left <= 0) {
                clearInterval(state.timers.global);
                finish();
            }
        }, 250);
    } else {
        state.timers.global = setInterval(() => {
            const el = ((Date.now() - state.startedAt) / 1000) | 0;
            $('globalTimer').textContent = fmt(el);
        }, 250);
    }
    render(true);
}

function startPerQ() {
    const cfg = MODES[state.mode];
    clearInterval(state.timers.perQ);
    state.qStartedAt = Date.now();
    
    state.timers.perQ = setInterval(() => {
        const elapsed = ((Date.now() - state.qStartedAt) / 1000) | 0;
        $('questionTimer').textContent = fmt(elapsed);

        // Time limit per question - automatically advance when time runs out
        if (cfg.timePerQ) {
            const left = cfg.timePerQ - elapsed;
            if (left <= 0) {
                recordQTime();
                state.skipped.add(state.index);
                clearInterval(state.timers.perQ);
                
                // Show alert for going over time
                alert(`Time's up! Moving to next question.`);
                
                // Always advance to next question when time runs out
                next();
                return;
            }
        }

        // Pace indicator updates
        const delta = overallDelta(cfg, elapsed);
        const ind = $('paceIndicator');
        const val = $('paceValue');
        
        if (cfg.perQWarn && elapsed > cfg.perQWarn) {
            ind.className = 'pace-indicator bad';
            ind.textContent = `OVER ${cfg.perQWarn}s`;
            val.textContent = `+${elapsed - cfg.perQWarn}s | Δ ${delta >= 0 ? '+' : '-'}${dClock(delta)}`;
        } else {
            if (delta > 15) {
                ind.className = 'pace-indicator warn';
                ind.textContent = 'BEHIND';
            } else if (delta < -15) {
                ind.className = 'pace-indicator ok';
                ind.textContent = 'AHEAD';
            } else {
                ind.className = 'pace-indicator ok';
                ind.textContent = 'ON TRACK';
            }
            val.textContent = `Δ ${delta >= 0 ? '+' : '-'}${dClock(delta)}`;
        }
    }, 1000);
}

function recordQTime() {
    const s = ((Date.now() - state.qStartedAt) / 1000) | 0;
    state.perQTimes[state.index] += s;
}

function render(first = false) {
    const q = state.questions[state.index];
    if (!q) {
        finish();
        return;
    }
    
    // Extract domain number
    const domainMatch = q.domain?.match(/Domain (\d)/);
    const domainText = domainMatch ? `Domain ${domainMatch[1]}` : 'Domain';
    $('domainBadge').textContent = domainText;
    
    const diff = (q.difficulty || 'medium').toLowerCase();
    const db = $('difficultyBadge');
    db.textContent = diff[0].toUpperCase() + diff.slice(1);
    db.className = 'badge difficulty-badge ' + diff;
    
    $('questionNumber').textContent = `Q${state.index + 1} of ${state.questions.length}`;
    $('scenario').textContent = q.scenario || '';
    $('questionText').textContent = q.question || '';

    const wrap = $('options');
    wrap.innerHTML = '';
    const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
    
    (q.options || []).forEach((opt, i) => {
        const d = document.createElement('div');
        d.className = 'option';
        d.onclick = () => select(i);
        d.innerHTML = `<div class="option-letter">${letters[i]}</div><div>${opt}</div>`;
        if (state.answers[state.index] === i) d.classList.add('selected');
        wrap.appendChild(d);
    });

    $('explanation').style.display = 'none';
    $('submitBtn').style.display = 'block';
    $('nextBtn').style.display = 'none';
    
    startPerQ();
    
    if (first) {
        $('paceIndicator').className = 'pace-indicator ok';
        $('paceIndicator').textContent = 'ON TRACK';
        $('paceValue').textContent = 'Δ +0m 00s';
    }
}

function select(i) {
    state.answers[state.index] = i;
    [...$('options').children].forEach((el, idx) => el.classList.toggle('selected', idx === i));
}

function submitAnswer() {
    const q = state.questions[state.index];
    if (state.answers[state.index] == null) {
        alert('Select an answer or Skip.');
        return;
    }
    
    recordQTime();
    clearInterval(state.timers.perQ);
    
    const chosen = state.answers[state.index];
    [...$('options').children].forEach((el, idx) => {
        el.classList.remove('selected');
        el.classList.add('disabled');
        el.classList.add(idx === q.correct ? 'correct' : (idx === chosen ? 'incorrect' : ''));
    });
    
    if (chosen === q.correct) state.correctCount++;
    
    $('correctExplanation').textContent = (q.explanation && q.explanation.correct) || '';
    $('strategyTip').textContent = (q.explanation && q.explanation.examStrategy) || '';
    $('explanation').style.display = 'block';
    
    // Automatically advance to next question after 2 seconds
    setTimeout(() => {
        next();
    }, 2000);
}

function next() {
    clearInterval(state.timers.perQ);
    if (state.index < state.questions.length - 1) {
        state.index++;
        render();
    } else {
        finish();
    }
}

function previousQuestion() {
    clearInterval(state.timers.perQ);
    if (state.index > 0) {
        state.index--;
        render();
    }
}

function skipQuestion() {
    recordQTime();
    state.skipped.add(state.index);
    next();
}

function toggleFlag() {
    state.flagged.has(state.index) ? state.flagged.delete(state.index) : state.flagged.add(state.index);
}

function finish() {
    clearInterval(state.timers.global);
    clearInterval(state.timers.perQ);
    $('questionContainer').style.display = 'none';
    $('resultsContainer').style.display = 'block';
    
    const total = state.questions.length;
    const pct = Math.round((state.correctCount / total) * 100);
    $('scoreText').textContent = `${pct}%`;
    $('correctCount').textContent = `${state.correctCount}/${total}`;
    $('timeUsed').textContent = fmt(((Date.now() - state.startedAt) / 1000) | 0);
    $('flaggedCount').textContent = state.flagged.size;
}

function resetQuiz() {
    clearInterval(state.timers.global);
    clearInterval(state.timers.perQ);
    state.mode = null;
    state.questions = [];
    state.index = 0;
    state.answers = [];
    state.flagged.clear();
    state.skipped.clear();
    $('resultsContainer').style.display = 'none';
    $('questionContainer').style.display = 'none';
    $('timerSection').style.display = 'none';
    $('modeSelection').style.display = 'grid';
    $('globalTimer').textContent = '00:00';
    $('questionTimer').textContent = '00:00';
    $('paceIndicator').className = 'pace-indicator ok';
    $('paceIndicator').textContent = 'ON TRACK';
    $('paceValue').textContent = 'Δ +0m 00s';
    window.scrollTo(0, 0);
}

function reviewAnswers() {
    alert('Detailed review coming next build.');
}

// Public API
window.startMode = startMode;
window.previousQuestion = previousQuestion;
window.submitAnswer = submitAnswer;
window.nextQuestion = next;
window.skipQuestion = skipQuestion;
window.toggleFlag = toggleFlag;
window.resetQuiz = resetQuiz;
window.reviewAnswers = reviewAnswers;
    </script>
</body>
</html>
